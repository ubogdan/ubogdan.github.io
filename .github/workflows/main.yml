name: CI
on:
  push:
    paths-ignore:
      - 'Makefile'
      - 'terraform/**'

# permission can be added at job level or workflow level
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2

      # Init Hugo theme
      - name: Update theme
        run: git submodule update --init

      # Prerequisites
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.95.0"

      # Build the site
      - name: Build
        run: hugo

      # AWS credentials for GitHub Actions
      # for more details visit https://github.com/marketplace/actions/configure-aws-credentials-action-for-github-actions
      - name: Set AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ASSUME_ROLE }}

      # Sync with S3 bucket
      - name: Upload content
        run: aws s3 sync public/ s3://${{ secrets.AWS_BUCKET }} --delete

      # Create Cloudfront invalidation
      - name: Cloudfront
        run: aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_CLOUDFRONT_ID }} --paths "/*"